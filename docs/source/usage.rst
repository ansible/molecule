Usage
=====

Installation
------------

Molecule is distributed as a python package, so you can use familiar methods to manage your installation:

* Install from `PyPI`_ with `pip`

  .. code-block:: bash

      pip install molecule

* Optionally in a `virtual environment`_

.. _`PyPI`: http://python-packaging-user-guide.readthedocs.org/en/latest/installing/#installing-from-pypi
.. _`virtual environment`: http://python-packaging-user-guide.readthedocs.org/en/latest/installing/#creating-virtual-environments

Installing from source
^^^^^^^^^^^^^^^^^^^^^^

Due to the rapid pace of development on this tool, you might want to
install it in "`development`_" mode so that new updates can be obtained by
simply doing a ``git pull`` in the repository's directory.

.. code-block:: bash

    cd /path/to/repos
    git clone git@github.com:metacloud/molecule.git
    cd molecule
    sudo python setup.py develop

There is also a `pip pattern` for development mode:

.. code-block:: bash

    cd /path/to/repos
    git clone git@github.com:metacloud/molecule.git
    pip install -U -e molecule/

Dependencies
------------

Molecule relies on several outside packages and programs to function.

- `Ansible`_
- `Vagrant`_
- `Serverspec`_
- `Testinfra`_
- `Rubocop`_
- `Rake`_

Configuration
-------------

In order to be compatible with Molecule, a role will require some basic
structure.

::

    role_name/
    ├── molecule.yml
    └─── playbook.yml

Optionally, if you want to test with `Serverspec`_, you will need::

    role_name/
    ├── ...
    ├── spec/
    ├────── spec_helper.rb
    └────── default_spec.rb

Optionally, if you want to test with `Testinfra`_, you will need::

    role_name/
    ├── ...
    ├── tests/
    └────── my_test.py


Molecule attempts to pick sane default configuration options (set
internally), however it's also possible to `override configuration`_,
for example in `~/.config/molecule/config.yml`.
Here is a commented example:

.. code-block:: yaml

    molecule:
      # file to look for in CWD when using ansible-playbook directly
      molecule_file: molecule.yml

      # directories to ignore when doing trailing whitespace checks on files during verify command
      ignore_paths:
        - .git
        - .vagrant
        - .molecule
        - .cache

      # directory to look for serverspec tests
      serverspec_dir: spec

      # directory to look for testinfra tests
      testinfra_dir: tests

      # directory in CWD to place all temp files, etc.
      molecule_dir: .molecule

      # where temporary state will be stored (lives under molecule_dir)
      state_file: state

      # name of inventory file generated by molecule (lives under molecule_dir)
      inventory_file: ansible_inventory

      # name of ansible config file generated by molecule (lives under molecule_dir)
      config_file: ansible.cfg

      # name of temporary vagrantfile created during runs (lives under molecule_dir)
      vagrantfile_file: vagrantfile
      rakefile_file: rakefile

      # template files to load when creating corresponding temporary files
      # this would be a good place to specify your own ansible.cfg template, for example
      vagrantfile_template: vagrantfile.j2
      ansible_config_template: ansible.cfg.j2
      rakefile_template: rakefile.j2

      # ssh arguments passed to molecule login command
      raw_ssh_args:
        - -o StrictHostKeyChecking=no
        - -o UserKnownHostsFile=/dev/null

      test:
        # sequence of commands to run when performing `molecule test`
        sequence:
          - destroy
          - create
          - converge
          - idempotence
          - verify
          - destroy

      init:
        # default platform to populate when doing `molecule init`
        platform:
          name: trusty64
          box: trusty64
          box_url: https://vagrantcloud.com/ubuntu/boxes/trusty64/versions/14.04/providers/virtualbox.box
        # templates to use when creating files during `molecule init`
        templates:
          molecule: molecule.yml.j2
          playbook: playbook.yml.j2
          spec_helper: spec_helper.rb.j2
          default_spec: default_spec.rb.j2

    # defaults for providers passed to Vagrant
    vagrant:
      providers:
        - name: virtualbox
          type: virtualbox
          options:
            memory: 512
            cpus: 2

    # defaults passed to ansible-playbook
    ansible:
      user: vagrant
      connection: ssh
      timeout: 30
      playbook: playbook.yml
      sudo: True
      sudo_user: False
      ask_sudo_pass: False
      ask_vault_pass: False
      vault_password_file: False
      limit: all
      verbose: False
      diff: True
      tags: False
      host_key_checking: False
      raw_ssh_args:
        - -o UserKnownHostsFile=/dev/null
        - -o IdentitiesOnly=yes
        - -o ControlMaster=auto
        - -o ControlPersist=60s


molecule.yml
------------

This file, located in the role directory, contains all the molecule-specific
information for the role in the directory in
which it's located. It allows you to configure how molecule, vagrant and
ansible will behave. This information is contained in 3 top level YAML sections: molecule,
ansible and vagrant.

The molecule section allows you to override molecule defaults, much like you
might do in a `config.yml` for molecule. This is is the most specific setting
for molecule and will override the contents of all other config files. This
is where you give molecule role-specific behavior.

.. code-block:: yaml

    molecule:
      raw_ssh_args:
        - -o StrictHostKeyChecking=false
        - -o UserKnownHostsFile=/dev/null

Ansible
-------

In the ansible section, you can configure flags exactly as they're
passed to ansible-playbook. Please note, however, that commands that
normally contain a hyphen (-) will need to be replaced with an underscore
(\_) to remain compatible with YAML.

Values set to *False* will **NOT** be passed to `ansible-playbook`, but
rather will be skipped entirely. An example ansible section of
`molecule.yml` may look something like this:

.. code-block:: yaml

    ansible:
      inventory_file: ../../inventory/
      diff: False
      sudo: True
      vault_password_file: ~/.vault

As you can see, the names of these values correspond to what the
underlying `ansible-playbook` accepts. As such, as the functionality of
Ansible grows, support for new CLI options will be supported simply by
adding its name: value combination to the ansible section of your
configuration.

The ansible section also supports a few values that aren't passed to
ansible-playbook in this way, but rather are passed as environment
variables. There are only a few currently in use.

.. code-block:: yaml

    ansible:
      config_file: /path/to/your/ansible.cfg
      playbook: /path/to/some/other_playbook.yml
      host_key_checking: False
      raw_ssh_args:
        - -o UserKnownHostsFile=/dev/null
        - -o IdentitiesOnly=yes
        - -o ControlMaster=auto
        - -o ControlPersist=60s
      raw_env_vars:
        ANSIBLE_ACTION_PLUGINS: ../plugins

The `raw_env_vars` section allows you to pass arbitrary environment
variables to ansible-playbook. This can be useful, for example, if you
want to do a role level override of a value normally found in
ansible.cfg.

Vagrant
-------

The other part of the configuration is the vagrant section. This is
where you will define what instances will be created, and how they will
be configured. Under the hood, molecule creates a Vagrantfile from a
template and populates it with the data you specify in this config.

Because it's impossible to support every Vagrant option, there are two
places where you can specify `raw\_config\_args.` The first is in the
root of the vagrant block, and this can be used for Vagrant options that
are not supported explicitly by Molecule currently - like
configuring port forwarding to a guest VM from your local machine.

The second place `raw\_config\_args` can be defined is within a specific
instance within the instances block. This allows you to define
instance-specific settings such as network interfaces with a config more
complicated than the interfaces section allows for.

Note: You can specify an options section for an instance. Currently, the
only key supported here is `append\_platform\_to\_hostname.` By setting
this to 'no' the platform name won't be appended to hostnames
automatically, which is the default. So, for example, an instance will
simply be named vagrant-01 instead of vagrant-01-rhel-7.

.. code:: yaml

    vagrant:
      raw_config_args:
        - "ssh.insert_key = false"
        - "vm.network 'forwarded_port', guest: 80, host: 8080"

      platforms:
        - name: trusty64
          box: trusty64
          box_url: https://vagrantcloud.com/ubuntu/boxes/trusty64/versions/14.04/providers/virtualbox.box

      providers:
        - name: virtualbox
          type: virtualbox
          options:
            memory: 512
            cpus: 2

      instances:
        - name: vagrant-01
          ansible_groups:
            - group_1
            - group_2
          interfaces:
            - network_name: private_network
              type: dhcp
              auto_config: true
              auto_config: false
          options:
            append_platform_to_hostname: no
          raw_config_args:
            - "vm.network 'private_network', type: 'dhcp', auto_config: false"

playbook.yml
------------

In general, your playbook.yml shouldn't require anything specific to
molecule. Rather, it should contain the logic you would like to apply in
order to test this particular role.

.. code-block:: yaml

    - hosts: all
      roles:
        - role: demo.molecule

Override Configuration
------------------------

You can specify a configuration file in the following places, in this order:

1. MOLECULE\_CONFIG environment variable
2. ~/.config/molecule/config.yml
3. /etc/molecule/config.yml

Molecule looks for configuration file and will stop looking for files once one of these is found,
so you *cannot* load settings from more than one of these locations.

Options specified in the (first found) configuration file will merge with (and
override) the defaults. Options not specified in the file will fall back
to defaults.

However, you can also specify settings in the `molecule.yml` file for a role under
the *ansible* section. These will be the most specific settings and will
override settings from all other files.

Using Molecule For Deployment
-----------------------------

In some cases, it may be desirable to use molecule to manage existing inventory, such as a lab.
Molecule has limited support for this concept by allowing a user to omit the ``vagrant`` block
in molecule.yml, and then specifying a path to ansible.cfg and inventory files. Molecule will
skip instance management in this scenario and only call ansible-playbook. Currently, only
molecule's ``converge`` command works in this configuration.

A molecule.yml such as this will trigger the described behavior:

.. code-block:: yaml

    ansible:
      playbook: playbook.yml
      config_file: /path/to/ansible.cfg
      inventory_file: /path/to/ansible_inventory
      extra_vars: my_var1=var1 my_var2=var2

Usage
-----

In the contexts of operations and virtualization, the word 'provision'
tends to refer to the initial creation of machines by allocating (hardware)
resources; in contrast, in the context of configuration management
(and in vagrant), 'provisioning' refers to taking the (virtual) machine
from an initial boot to having run the configuration management system
(Ansible, Salt, Puppet, Chef CFEngine or just shell). Molecule uses the term
'converge' (as does Test Kitchen) to refer to this latter meaning of
'provisioning' (i.e. "Run Ansible on the new test VM").

It is very simple to run tests using the molecule command from the working
directory of your role.

* ``molecule destroy``: Halts and destroys all instances associated with current role.
* ``molecule create``: Builds instances specified in molecule.yml.
* ``molecule converge``: Runs playbook.yml against instances associated with current
  role.
* ``molecule idempotence``: Checks output of ansible-playbook for "changed"/"failed".
* ``molecule verify``: Runs the functional tests (serverspec, testinfra).
* ``molecule login <host>``: Login to an instance via ssh.
* ``molecule init <role>``: Creates the directory structure and files for a new Ansible
  role compatible with molecule.
* ``molecule test``: Runs a series of commands to create, verify and destroy instances.

Note: The exact sequence of commands run during the ``test`` command can be configured
in the `test['sequence']` config option.

Integration Testing
--------------------

Molecule supports testing using both `Serverspec`_ and `Testinfra`_. Tests
located in the ``spec/`` directory will be run by serverspec and tests
located in the ``tests/`` directory will be run by testinfra. Both of these
directories can be changed as molecule config options. Molecule will run
serverspec and testinfra if both directories are present.

When using serverspec, it's possible to target tests at the following
levels: all instances, specific groups, specific instances.

All files matching the pattern ``spec/*_spec.rb`` will be run against
every instance.

Tests located in ``spec/hosts/<hostname>/*_spec.rb`` will be run against
the specific instance with the given hostname.

Tests located in ``spec/groups/<groupname>/*_spec.rb`` will be run
against the instances in the given group.

Please note, this behavior only pertains to inventory generated by
Molecule. Specifying outside inventory files or scripts will disable
this functionality.

.. _`Ansible`: https://docs.ansible.com
.. _`Vagrant`: http://docs.vagrantup.com/v2
.. _`Serverspec`: http://serverspec.org
.. _`Testinfra`: http://testinfra.readthedocs.org
.. _`Rake`: https://github.com/ruby/rake
.. _`Rubocop`: https://github.com/bbatsov/rubocop
.. _`development`: http://pythonhosted.org/setuptools/setuptools.html#development-mode
.. _`pip pattern`: http://python-packaging-user-guide.readthedocs.org/en/latest/distributing/#working-in-development-mode
