---
- name: Create
  hosts: localhost
  gather_facts: true    
  tasks:
    - name: Create a container
      containers.podman.podman_container:
        name: "{{ item.name }}"
        image: "{{ item.image }}"
        privileged: "{{ item.privileged | default(omit) }}"
        volumes: "{{ item.volumes | default(omit) }}"
        capabilities: "{{ item.capabilities | default(omit) }}"
        systemd: "{{ item.systemd | default(omit) }}"
        state: started
        command: "{{ item.command | default('sleep 1d') }}"
        log_driver: json-file
        env: "{{ item.env | default(omit) }}"
      register: result
      loop: "{{ molecule_yml.platforms }}"
      loop_control:
        label: "{{ item.name }}"
    
    - name: Display container log and fail
      ansible.builtin.fail:
        msg: |
          Container failed to start. Logs:
          {{ container_logs | default('Unable to retrieve logs') }}
      vars:
        container_logs: "{{ lookup('pipe', 'podman logs ' + item.container.Name, errors='ignore') }}"
        exit_code: "{{ item.container.State.ExitCode }}"
        running: "{{ item.container.State.Running }}"
      when: (exit_code | int) != 0 or not (running | bool)
      loop: "{{ result.results }}"
      loop_control:
        label: "{{ item.container.Name }}"

